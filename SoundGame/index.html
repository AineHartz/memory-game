<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Melody Memory Game Survival Mode</title>

    <style>
        .square {
            display: inline-block;
            width: 50px;
            height: 50px;
            margin: 10px;
            background-color: gray;
            text-align: center;
            line-height: 50px;
            font-size: 18px;
            color: white;
        }
        .square.red {
            background-color: red;
        }
    </style>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>

<body>
    <h1>Melody Memory Survival Mode</h1>
    <p>Instructions: Recite the melody to win!</p>

    <button type="button" id="startQuitButton" onclick="toggleGame()">Start</button>
    <button type="button" id="listenButton" style="display:none;" onclick="startListening()">Start Listening</button>
    <button type="button" id="stopButton" style="display:none;" onclick="stopListening()">Stop Listening</button>

    <div id="squareContainer"></div> 

    <!--displayed when game is quit-->
    <div id="endMessage" style="display:none;">
        <p>Thanks for playing!</p>
    </div>

    <script>
        const socket = io(); //SocketIO connection
        let gameRunning = false; //track game state
        let listeningMode = false; //toggle for listening mode
        let recordedKeys = []; //store pressed keys

        function toggleGame() {
            if (!gameRunning) {
                startGame(); //start the game
            } else {
                quitGame(); //quit the game
            }
        }

        function startGame() {
            //hide the end message
            document.getElementById('endMessage').style.display = 'none';
            gameRunning = true;
            const startQuitButton = document.getElementById('startQuitButton');
            startQuitButton.innerText = "Quit"; //change button text to "Quit"
            
            const squareContainer = document.getElementById('squareContainer');
            squareContainer.innerHTML = ''; //clear existing squares
            drawSquares(squareContainer);

            startMelody(); //start the melody
        }

        function quitGame() {
            gameRunning = false;
            const startQuitButton = document.getElementById('startQuitButton');
            startQuitButton.innerText = "Start"; //change button text to "Start"

            // Hide listening and stop buttons
            document.getElementById('listenButton').style.display = 'none';
            document.getElementById('stopButton').style.display = 'none';

            // Send a stop signal to the backend if needed
            socket.emit('quit_game'); //notify the backend

            // Show the end message
            document.getElementById('endMessage').style.display = 'block';
        }

    function startMelody() {
        // Send a POST request to trigger melody generation
        fetch('/start_melody', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.message); // Display message if needed
            document.getElementById('listenButton').style.display = 'inline-block'; // Show "Start Listening" button
        })
        .catch(error => console.error('Error:', error));
    }

        function startListening() {
            listeningMode = true; // Enable listening mode
            recordedKeys = []; // Clear recorded keys from any previous session
            document.addEventListener('keydown', handleKeyPress);
            document.addEventListener('keyup', handleKeyRelease);
            document.getElementById('listenButton').style.display = 'none'; // Hide "Start Listening" button
            document.getElementById('stopButton').style.display = 'inline-block'; // Show "Stop Listening" button
        }

        function stopListening() {
            listeningMode = false; // Disable listening mode
            document.removeEventListener('keydown', handleKeyPress);
            document.removeEventListener('keyup', handleKeyRelease);
            document.getElementById('stopButton').style.display = 'none'; // Hide "Stop Listening" button

            console.log('Recorded keys:', recordedKeys); // For debugging
            // Send recorded keys to backend
            fetch('/user_input', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ userInput: recordedKeys }) // Send the keys as JSON
            })
            .then(response => response.json())
            .then(data => console.log(data.message))
            .catch(error => console.error('Error:', error));
        }

        function drawSquares(container) {
            const letters = ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k'];
            letters.forEach(letter => {
                const square = document.createElement('div');
                square.classList.add('square');
                square.setAttribute('id', `square-${letter}`); // Give each square a unique ID based on the letter
                square.innerText = letter;
                container.appendChild(square);
            });
        }
        
        function handleKeyPress(event) {
            if (!listeningMode) return;

            const key = event.key.toLowerCase();
            const square = document.getElementById(`square-${key}`);
            
            if (square) {
                recordedKeys.push(key); // Record the pressed key (even if it's pressed multiple times)
                square.classList.add('red'); // Turn the square red
                playMidiForKey(key); // Play the corresponding MIDI file every time the key is pressed
            }
        }

        function handleKeyRelease(event) {
            if (!listeningMode) return;

            const key = event.key.toLowerCase();
            const square = document.getElementById(`square-${key}`);
            if (square) {
                square.classList.remove('red'); // Revert square color when the key is released
            }
        }

        function playMidiForKey(key) {
            const midiMap = {
                'a': 'MID_FILES/c_note_one_sec.mid',
                's': 'MID_FILES/d_note_one_sec.mid',
                'd': 'MID_FILES/e_note_one_sec.mid',
                'f': 'MID_FILES/f_note_one_sec.mid',
                'g': 'MID_FILES/g_note_one_sec.mid',
                'h': 'MID_FILES/a_note_one_sec.mid',
                'j': 'MID_FILES/b_note_one_sec.mid',
                'k': 'MID_FILES/c_oct_note_one_sec.mid'
            };

            const midiFile = midiMap[key];
            if (midiFile) {
                socket.emit('play_midi', { midiFile: midiFile }); // Emit event to server to play MIDI
            }
        }

        // Listen for the 'highlight_square' event from the server
        socket.on('highlight_square', function(data) {
            const letter = data.letter;
            const square = document.getElementById(`square-${letter}`);
            if (square) {
                square.classList.add('red');
            }
        });

        // Listen for the 'reset_square' event to turn squares back to grey
        socket.on('reset_square', function(data) {
            const letter = data.letter;
            const square = document.getElementById(`square-${letter}`);
            if (square) {
                square.classList.remove('red');
            }
        });
        // Automatically move to the next round if user input was correct
    socket.on('next_round', function() {
        console.log('User input was correct. Starting next round...');
        startMelody();  // Start a new round automatically
    });

    // Handle game over
    socket.on('game_over', function(data) {
        const { level, score } = data;
        alert(`Game Over!\nLevel: ${level}\nScore: ${score}`);
    });

    </script>
</body>
</html>

